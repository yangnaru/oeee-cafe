{% extends "base.jinja" %}
{% block title %}
  {{ super() }} | {{ community.name }}
{% endblock title %}
{% block head %}
  <link rel="alternate"
        type="application/activity+json"
        href="https://{{ domain }}/ap/communities/{{ community.id }}" />
{% endblock head %}
{% block content %}
  <div class="center">
    {% block community_edit_block %}
      <div hx-target="this" hx-swap="outerHTML" class="community-header">
        <div>
          <h2>{{ community.name }}</h2>
          <p class="community-handle">@{{ community.slug }}@{{ domain }}</p>
        </div>
        <p class="community-description">{{ community.description }}</p>
        {% if current_user.id == community.owner_id %}
          <div class="community-menu">
            <button hx-get="/communities/{{ community_id }}/edit">{{ ftl_get_message("edit") }}</button>
          </div>
        {% endif %}
      </div>
    {% endblock community_edit_block %}

    {% if stats %}
      <div class="community-stats-card">
        <div class="community-stats-content">
          <strong>{{ ftl_get_message("community-stats") }}:</strong>
          {{ stats.total_posts }} {{ ftl_get_message("community-stats-posts") }} ·
          {{ stats.total_contributors }} {{ ftl_get_message("community-stats-contributors") }} ·
          {{ stats.total_comments }} {{ ftl_get_message("community-stats-comments") }}
        </div>
        {% if current_user and community.background_color %}
          <form action="/draw" method="post" class="community-stats-draw-form">
            <input type="hidden" name="community_id" value="{{ community_id }}" />
            <input type="hidden" name="tool" value="cucumber" />
            <input type="hidden" name="width" value="640" />
            <input type="hidden" name="height" value="480" />
            <input type="submit" value="{{ ftl_get_message("community-drawing-new") }}" />
          </form>
        {% endif %}
      </div>
    {% endif %}

    {% if current_user and not community.background_color %}
      <div class="community-drawing-card">
        <form action="/draw" method="post">
          <input type="hidden" name="community_id" value="{{ community_id }}" />
          <select name="tool" title="{{ ftl_get_message("community-drawing-tool") }}">
            <option value="neo" selected>PaintBBS NEO</option>
            <option value="tegaki">Tegaki</option>
          </select>
          <select name="width" title="{{ ftl_get_message("community-drawing-width") }}">
            <option value="300" selected>300</option>
            <option value="350">350</option>
            <option value="400">400</option>
            <option value="450">450</option>
            <option value="500">500</option>
            <option value="550">550</option>
            <option value="600">600</option>
            <option value="650">650</option>
            <option value="700">700</option>
            <option value="750">750</option>
            <option value="800">800</option>
            <option value="850">850</option>
            <option value="900">900</option>
            <option value="950">950</option>
            <option value="1000">1000</option>
          </select>
          <span>×</span>
          <select name="height" title="{{ ftl_get_message("community-drawing-height") }}">
            <option value="300" selected>300</option>
            <option value="350">350</option>
            <option value="400">400</option>
            <option value="450">450</option>
            <option value="500">500</option>
            <option value="550">550</option>
            <option value="600">600</option>
            <option value="650">650</option>
            <option value="700">700</option>
            <option value="750">750</option>
            <option value="800">800</option>
          </select>
          <input type="submit" value="{{ ftl_get_message("community-drawing-new") }}" />
        </form>
      </div>
    {% endif %}
    {% if comments %}
      <div class="community-section">
        <div class="community-section-header">
          <h3 class="community-section-title">{{ ftl_get_message("recent-comments") }}</h3>
          {% if stats.total_comments > 5 %}
            <a href="/communities/@{{ community.slug }}/comments" class="community-section-link">{{ ftl_get_message("view-all-comments") }}</a>
          {% endif %}
        </div>
        {% for comment in comments %}
          <a href="/@{{ comment.post_author_login_name }}/{{ comment.post_id }}" class="comment-card-link">
            <div class="comment">
              {% if comment.post_image_filename %}
                <div class="comment-thumbnail">
                  <img src="{{ r2_public_endpoint_url }}/image/{{ comment.post_image_filename[:2] }}/{{ comment.post_image_filename }}"
                       alt="{{ comment.post_title }}"
                       width="{{ comment.post_image_width }}"
                       height="{{ comment.post_image_height }}">
                </div>
              {% endif %}
              <div class="comment-body">
                <div class="comment-header">
                  {% if comment.is_local %}
                    <span class="comment-author">{{ comment.actor_name }}</span>
                  {% else %}
                    <span class="comment-author">{{ comment.actor_name }}</span>
                  {% endif %}
                  <span class="muted comment-handle">{{ comment.actor_handle }}</span>
                  <span class="muted comment-timestamp">{{ comment.created_at|datetimeformat(format="short", tz="Asia/Seoul") }}</span>
                </div>
                <div class="comment-content">
                  {% if comment.content_html %}
                    {{ comment.content_html|safe }}
                  {% else %}
                    {{ comment.content|markdown|safe }}
                  {% endif %}
                </div>
                {% if comment.post_title %}
                  <div class="comment-post-reference">
                    → {{ comment.post_title }}
                  </div>
                {% else %}
                  <div class="comment-post-reference">
                    → {{ ftl_get_message("post-no-title") }}
                  </div>
                {% endif %}
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    {% endif %}
    <div class="community-section">
      <h3 class="community-section-title">{{ ftl_get_message("recent-drawings") }}</h3>
      {% if posts %}
        <div class="posts-grid">
          {% for post in posts %}
            <div class="posts-grid-item">
              <a href="/@{{ post.user_login_name }}/{{ post.id }}">
                <img alt="{{ post.title }}"
                     width="{{ post.image_width }}"
                     height="{{ post.image_height }}"
                     src="{{ r2_public_endpoint_url }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
              </a>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>{{ ftl_get_message("community-no-posts") }}</p>
      {% endif %}
    </div>
  </div>
{% endblock content %}
