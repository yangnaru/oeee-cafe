{% extends "base.jinja" %}
{% block head %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Handle hashtag autocomplete clicks
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('hashtag-autocomplete-item')) {
          const input = document.getElementById('hashtags-input');
          const hashtag = e.target.dataset.hashtag;
          const currentValue = input.value;

          // Split by comma or space and get all tags except the last one being typed
          const tags = currentValue.split(/[,\s]+/).filter(t => t.trim());
          tags.pop(); // Remove the last incomplete tag

          // Add the selected hashtag and join back
          tags.push(hashtag);
          input.value = tags.join(', ') + ', ';

          // Clear the suggestions
          document.getElementById('hashtag-suggestions').innerHTML = '';

          // Focus back on input
          input.focus();
        }
      });
    });
  </script>
{% endblock head %}
{% block content %}
  <div class="center">
    <p>{{ ftl_get_message("post-created-at") }}: {{ post.created_at }}</p>
    <p>{{ ftl_get_message("post-duration") }}: {{ post.paint_duration }}</p>
    <img width="{{ post.image_width }}"
         height="{{ post.image_height }}"
         alt="{{ ftl_get_message("draft-post") }}"
         src="{{ r2_public_endpoint_url }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
    <form action="/posts/publish" method="post">
      <input type="hidden" name="post_id" value="{{ post.id }}" />
      <p>
        {{ ftl_get_message("community") }}:
        <a href="{{ link }}">{{ post.community_name }}</a>
      </p>
      <p>
        <label for="title">{{ ftl_get_message("post-title") }}:</label>
        <input type="text" name="title" />
      </p>
      <p>
        <label for="content">{{ ftl_get_message("post-description") }}:</label>
        <textarea name="content"></textarea>
      </p>
      <p>
        <label for="hashtags">{{ ftl_get_message("post-hashtags") }}:</label>
        <div class="hashtag-input-container">
          <input type="text"
                 id="hashtags-input"
                 name="hashtags"
                 placeholder="{{ ftl_get_message("post-hashtags-placeholder") }}"
                 autocomplete="off"
                 hx-get="/api/hashtags/autocomplete"
                 hx-trigger="keyup changed delay:300ms"
                 hx-target="#hashtag-suggestions"
                 hx-include="[name='hashtags']"
                 hx-vals='js:{q: document.getElementById("hashtags-input").value.split(/[,\s]+/).pop()}' />
          <div id="hashtag-suggestions" class="hashtag-autocomplete"></div>
        </div>
        <span class="form-hint">{{ ftl_get_message("post-hashtags-hint") }}</span>
      </p>
      <p>
        <label for="is_sensitive">{{ ftl_get_message("sensitive") }}:</label>
        <input type="checkbox" name="is_sensitive" />
      </p>
      <div>
        <label>{{ ftl_get_message("allow-relay") }}:</label>
        <input type="checkbox" name="allow_relay" checked />
      </div>
      <input type="submit" value="{{ ftl_get_message("post-publish") }}" />
    </form>
    <form hx-delete="/posts/{{ post_id }}"
          hx-confirm="{{ ftl_get_message("post-delete-confirm") }}"
          hx-target="body">
      <button type="submit">{{ ftl_get_message("delete") }}</button>
    </form>
  </div>
{% endblock content %}
