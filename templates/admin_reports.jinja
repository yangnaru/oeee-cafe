{% extends "base.jinja" %}
{% block title %}{{ super() }} | {{ ftl_get_message("admin-reports-title") }}{% endblock title %}
{% block content %}
  <div class="center">
    <h1>{{ ftl_get_message("admin-reports-title") }}</h1>

    <div style="margin-bottom: 20px;">
      <label for="status-filter" style="margin-right: 10px;">{{ ftl_get_message("admin-reports-filter-status") }}</label>
      <select id="status-filter" onchange="loadReports()" style="padding: 8px; border: 1px solid var(--main-border-color); border-radius: 3px; background: var(--secondary-bg-color); color: var(--primary-text-color);">
        <option value="">{{ ftl_get_message("admin-reports-all-statuses") }}</option>
        <option value="pending" selected>{{ ftl_get_message("admin-reports-status-pending") }}</option>
        <option value="reviewed">{{ ftl_get_message("admin-reports-status-reviewed") }}</option>
        <option value="actioned">{{ ftl_get_message("admin-reports-status-actioned") }}</option>
        <option value="dismissed">{{ ftl_get_message("admin-reports-status-dismissed") }}</option>
      </select>
    </div>

    <div id="reports-container" style="margin-top: 20px;">
      <p>{{ ftl_get_message("admin-reports-loading") }}</p>
    </div>
  </div>

  <script>
    async function loadReports() {
      const statusFilter = document.getElementById('status-filter').value;
      const container = document.getElementById('reports-container');

      try {
        const url = '/api/v1/reports' + (statusFilter ? '?status=' + statusFilter : '');
        const response = await fetch(url);
        const data = await response.json();

        if (!response.ok) {
          container.innerHTML = '<p style="color: red;">' + (data.error || 'Failed to load reports') + '</p>';
          return;
        }

        if (data.reports.length === 0) {
          container.innerHTML = '<p>{{ ftl_get_message("admin-reports-no-reports") }}</p>';
          return;
        }

        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: var(--secondary-bg-color); border-bottom: 2px solid var(--main-border-color);">';
        html += '<th style="padding: 10px; text-align: left;">{{ ftl_get_message("admin-reports-post") }}</th>';
        html += '<th style="padding: 10px; text-align: left;">{{ ftl_get_message("admin-reports-author") }}</th>';
        html += '<th style="padding: 10px; text-align: left;">{{ ftl_get_message("admin-reports-reporter") }}</th>';
        html += '<th style="padding: 10px; text-align: left;">{{ ftl_get_message("admin-reports-reason") }}</th>';
        html += '<th style="padding: 10px; text-align: left;">{{ ftl_get_message("admin-reports-status") }}</th>';
        html += '<th style="padding: 10px; text-align: left;">{{ ftl_get_message("admin-reports-created") }}</th>';
        html += '<th style="padding: 10px; text-align: left;">{{ ftl_get_message("admin-reports-actions") }}</th>';
        html += '</tr></thead><tbody>';

        for (const report of data.reports) {
          html += '<tr style="border-bottom: 1px solid var(--main-border-color);">';
          html += '<td style="padding: 10px;"><a href="/posts/' + report.post_id + '">' + (report.post_title || '{{ ftl_get_message("post-no-title") }}') + '</a></td>';
          html += '<td style="padding: 10px;">@' + report.post_author_login_name + '</td>';
          html += '<td style="padding: 10px;">@' + report.reporter_login_name + '</td>';
          html += '<td style="padding: 10px;">';
          html += '<div><strong>' + formatReason(report.reason) + '</strong></div>';
          if (report.details) {
            html += '<div style="color: #666; font-size: 0.9em; margin-top: 5px;">' + escapeHtml(report.details) + '</div>';
          }
          html += '</td>';
          html += '<td style="padding: 10px;"><span style="padding: 3px 8px; border-radius: 3px; background: ' + getStatusColor(report.status) + ';">' + formatStatus(report.status) + '</span></td>';
          html += '<td style="padding: 10px;">' + new Date(report.created_at).toLocaleString() + '</td>';
          html += '<td style="padding: 10px;">';
          if (report.status === 'pending') {
            html += '<select onchange="updateReportStatus(\'' + report.id + '\', this.value)" style="padding: 5px; border: 1px solid var(--main-border-color); border-radius: 3px; background: var(--secondary-bg-color); color: var(--primary-text-color);">';
            html += '<option value="">{{ ftl_get_message("admin-reports-select-action") }}</option>';
            html += '<option value="reviewed">{{ ftl_get_message("admin-reports-mark-reviewed") }}</option>';
            html += '<option value="actioned">{{ ftl_get_message("admin-reports-mark-actioned") }}</option>';
            html += '<option value="dismissed">{{ ftl_get_message("admin-reports-mark-dismissed") }}</option>';
            html += '</select>';
          } else {
            html += '{{ ftl_get_message("admin-reports-no-action") }}';
          }
          html += '</td>';
          html += '</tr>';
        }

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = '<p style="color: red;">{{ ftl_get_message("admin-reports-error-loading") }}</p>';
      }
    }

    async function updateReportStatus(reportId, newStatus) {
      if (!newStatus) return;

      try {
        const response = await fetch('/api/v1/reports/' + reportId, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();

        if (response.ok) {
          alert(data.message || '{{ ftl_get_message("admin-reports-status-updated") }}');
          loadReports();
        } else {
          alert(data.error || '{{ ftl_get_message("admin-reports-error-updating") }}');
        }
      } catch (error) {
        alert('{{ ftl_get_message("admin-reports-error-updating") }}');
      }
    }

    function formatReason(reason) {
      const reasons = {
        'spam': '{{ ftl_get_message("post-report-reason-spam") }}',
        'harassment': '{{ ftl_get_message("post-report-reason-harassment") }}',
        'inappropriate_content': '{{ ftl_get_message("post-report-reason-inappropriate") }}',
        'copyright_violation': '{{ ftl_get_message("post-report-reason-copyright") }}',
        'other': '{{ ftl_get_message("post-report-reason-other") }}'
      };
      return reasons[reason] || reason;
    }

    function formatStatus(status) {
      const statuses = {
        'pending': '{{ ftl_get_message("admin-reports-status-pending") }}',
        'reviewed': '{{ ftl_get_message("admin-reports-status-reviewed") }}',
        'actioned': '{{ ftl_get_message("admin-reports-status-actioned") }}',
        'dismissed': '{{ ftl_get_message("admin-reports-status-dismissed") }}'
      };
      return statuses[status] || status;
    }

    function getStatusColor(status) {
      const colors = {
        'pending': '#ffd700',
        'reviewed': '#87ceeb',
        'actioned': '#90ee90',
        'dismissed': '#ddd'
      };
      return colors[status] || '#ddd';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load reports on page load
    loadReports();
  </script>
{% endblock content %}
