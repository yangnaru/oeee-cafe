{% import "comments_macro.jinja" as comments_macro %}

{% macro render_post_card(post, depth) %}
  <div style="margin-left: {{ depth * 20 }}px; margin-bottom: 15px;">
    <a href="/@{{ post.community_slug if post.community_slug else post.user_login_name }}/{{ post.id }}" class="post-card" style="text-decoration: none; color: inherit; display: block; border: 1px solid var(--main-border-color); padding: 15px;">
      <div style="display: flex; gap: 10px; align-items: flex-start;">
        <img src="{{ r2_public_endpoint_url }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}"
             alt="{{ post.title or 'No title' }}"
             style="max-width: 100px; height: auto; border: 1px solid #ccc;">
        <div style="flex-grow: 1;">
          <div>
            <span style="font-weight: bold;">
              {% if post.title %}{{ post.title }}{% else %}{{ ftl_get_message("post-no-title") }}{% endif %}
            </span>
          </div>
          {% if post.content %}
            <div style="color: #666; font-size: 0.85em; margin-top: 4px; line-height: 1.3;">
              {{ post.content[:100] }}{% if post.content|length > 100 %}...{% endif %}
            </div>
          {% endif %}
          <div style="color: #666; font-size: 0.9em; margin-top: 4px;">
            by <span style="font-weight: normal;">{{ post.user_display_name }}</span>
            <span class="muted">{{ post.user_actor_handle }}</span>
            {% if post.published_at_formatted %}
              · {{ post.published_at_formatted }}
            {% endif %}
            {% if post.comments_count > 0 %}
              · {{ post.comments_count }} {{ ftl_get_message("post-comments") }}
            {% endif %}
          </div>
        </div>
      </div>
    </a>
    {% if post.children %}
      {% for child in post.children %}
        {{ render_post_card(child, depth + 1) }}
      {% endfor %}
    {% endif %}
  </div>
{% endmacro %}

{% extends "base.jinja" %}
{% block title %}
  {{ super() }} |
  {% if post.title %}
    {{ post.title }}
  {% else %}
    {{ ftl_get_message("post-no-title") }}
  {% endif %}
{% endblock title %}
{% block head %}
  {% if not post_community or post_community.visibility != "private" %}
    <link rel="alternate"
          type="application/activity+json"
          href="https://{{ domain }}/ap/posts/{{ post.id }}" />
    <meta property="og:title" content="{{ post.title }}" />
    <meta property="og:description" content="{{ post.content }}" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ base_url|safe }}/posts/{{ post_id }}" />
    <meta property="og:image"
          content="{{ r2_public_endpoint_url|safe }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
    <meta property="twitter:site" content="@oeee_cafe">
    <meta property="twitter:domain" content="oeee.cafe">
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:url"
          content="{{ base_url|safe }}/posts/{{ post_id }}">
    <meta name="twitter:title" content="{{ post.title }}">
    <meta name="twitter:description" content="{{ post.content }}">
    <meta name="twitter:image"
          content="{{ r2_public_endpoint_url|safe }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}">
  {% else %}
    <meta name="robots" content="noindex, nofollow">
  {% endif %}
{% endblock head %}
{% block content %}
  <div class="center">
    <div class="post-sidebar">
      {# Parent post #}
      {% if parent_post_data %}
        <div class="parent-post-section">
          <h3 class="section-heading">{{ ftl_get_message("post-replying-to") }}</h3>
          {{ render_post_card(parent_post_data, 0) }}
        </div>
      {% endif %}

      {# Two-column layout: Image on left, Info on right #}
      <div class="post-detail-container">
        {# LEFT COLUMN: Image #}
        <div class="post-detail-left">
          {% if post.image_tool == "neo" and post.allow_relay == "true" %}
            <a href="/@{{ post.community_slug if post.community_slug else post.login_name }}/{{ post_id }}/relay">
              <img class="post-image-full"
                   width="{{ post.image_width }}"
                   height="{{ post.image_height }}"
                   alt="{{ post.title }}"
                   src="{{ r2_public_endpoint_url|safe }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
            </a>
          {% else %}
            <img class="post-image-full"
                 width="{{ post.image_width }}"
                 height="{{ post.image_height }}"
                 alt="{{ post.title }}"
                 src="{{ r2_public_endpoint_url|safe }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
          {% endif %}
        </div>

        {# RIGHT COLUMN: Info #}
        <div class="post-detail-right">
          {# Author Info #}
          <div class="post-author-info">
            <div>
              <strong>{{ ftl_get_message("post-author") }}:</strong>
              <a href="/@{{ post.login_name }}">{{ post.display_name }}</a>
              <span class="muted fediverse-handle">@{{ post.login_name }}@{{ domain }}</span>
            </div>
            {% if collaborative_participants %}
              <div class="collaborative-participants">
                <strong>{{ ftl_get_message("post-collaborative-participants") }}:</strong>
                {% for participant in collaborative_participants %}
                  <a href="/@{{ participant.login_name }}">@{{ participant.display_name }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          {# Metadata #}
          <div class="post-metadata">
            <p>{{ ftl_get_message("post-published-at") }}: {{ post.published_at }}</p>
            <p>
              {{ ftl_get_message("post-duration") }}: {{ post.paint_duration }}
              {% if post.replay_filename %}
                · <a href="/@{{ post.community_slug if post.community_slug else post.login_name }}/{{ post_id }}/replay">{{ ftl_get_message("post-replay") }}</a>
              {% endif %}
            </p>
            {% if post.community_slug %}
              <p>{{ ftl_get_message("community") }}: <a href="/communities/@{{ post.community_slug }}">{{ post.community_name }}</a>
                {% if current_user.id == post.author_id and (not post_community or post_community.visibility != "private") and not post.parent_post_id and not (post_community and post_community.background_color and post_community.foreground_color) %}
                  (<a href="/@{{ post.community_slug }}/{{ post_id }}/edit/community">{{ ftl_get_message("edit") }}</a>)
                {% endif %}
              </p>
            {% else %}
              {# Personal post - show edit link #}
              {% if current_user.id == post.author_id and not post.parent_post_id %}
                <p>(<a href="/@{{ post.login_name }}/{{ post_id }}/edit/community">{{ ftl_get_message("edit-community-button") }}</a>)</p>
              {% endif %}
            {% endif %}
            <p>HIT: {{ post.viewer_count }}</p>
          </div>

          {# Header: Title, Hashtags, and Description #}
          {% block post_edit_block %}
            <div id="post-edit-container" hx-target="this" hx-swap="outerHTML">
              <div class="post-header">
                <h1 class="post-title">
                  {% if post.title %}
                    {{ post.title }}
                  {% else %}
                    {{ ftl_get_message("post-no-title") }}
                  {% endif %}
                </h1>
                {% if hashtags %}
                  <div class="post-hashtags">
                    {% for hashtag in hashtags %}
                      <a href="/hashtags/{{ hashtag.name }}" class="hashtag-link">#{{ hashtag.display_name }}</a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              {# Description #}
              {% if post.content %}
                <div class="post-content">{{ post.content|markdown|safe }}</div>
              {% endif %}
            </div>
          {% endblock post_edit_block %}

          {# Actions #}
          <div class="post-actions">
            {% if current_user %}
              <div class="post-action-buttons">
                {% if post.image_tool == "neo" and post.allow_relay == "true" %}
                  <button type="button" onclick="window.location.href='/@{{ post.community_slug if post.community_slug else post.login_name }}/{{ post_id }}/relay'">{{ ftl_get_message("post-relay") }}</button>
                {% endif %}
                <button type="button" onclick="document.getElementById('reply-form-{{ post_id }}').style.display = document.getElementById('reply-form-{{ post_id }}').style.display === 'none' ? 'block' : 'none'">{{ ftl_get_message("post-reply-with-drawing") }}</button>
                <button type="button" onclick="
                  const url = '{{ base_url|safe }}/@{{ post.community_slug if post.community_slug else post.login_name }}/{{ post_id }}';
                  if (navigator.share) {
                    navigator.share({ title: '{{ post.title|default(ftl_get_message("post-no-title"))|safe }}', url: url });
                  } else {
                    navigator.clipboard.writeText(url).then(() => alert('{{ ftl_get_message("post-share-copied") }}'));
                  }
                ">{{ ftl_get_message("post-share") }}</button>
                {% if current_user.id == post.author_id %}
                  <button hx-get="/posts/{{ post_id }}/edit" hx-target="#post-edit-container" hx-swap="outerHTML">{{ ftl_get_message("edit") }}</button>
                  <form hx-delete="/posts/{{ post_id }}"
                        hx-confirm="{{ ftl_get_message('post-delete-confirm') }}"
                        hx-target="body"
                        style="display: inline;">
                    <button type="submit">{{ ftl_get_message("delete") }}</button>
                  </form>
                {% endif %}
              </div>
              <fieldset id="reply-form-{{ post_id }}" style="display: none;">
                <legend>{{ ftl_get_message("post-reply-select-tool") }}</legend>
                {% if post_community and post_community.background_color and post_community.foreground_color %}
                  <form action="/collaborate/" method="get" onsubmit="setOrientationDimensions(event, this)">
                    <input type="hidden" name="offline" value="true" />
                    <input type="hidden" name="twoTone" value="true" />
                    <input type="hidden" name="backgroundColor" value="{{ post_community.background_color }}" />
                    <input type="hidden" name="foregroundColor" value="{{ post_community.foreground_color }}" />
                    <input type="hidden" name="community_id" value="{{ post.community_id }}" />
                    <input type="hidden" name="parent_post_id" value="{{ post_id }}" />
                    <input type="hidden" name="width" value="640" />
                    <input type="hidden" name="height" value="480" />
                    <label>
                      <input type="radio" name="orientation" value="landscape" checked />
                      {{ ftl_get_message('community-drawing-landscape') }} (640 × 480)
                    </label>
                    <label>
                      <input type="radio" name="orientation" value="portrait" />
                      {{ ftl_get_message('community-drawing-portrait') }} (480 × 640)
                    </label>
                    <input type="submit" value="Start Drawing" />
                  </form>
                  <script>
                    function setOrientationDimensions(event, form) {
                      const orientation = form.querySelector('input[name="orientation"]:checked').value;
                      if (orientation === 'landscape') {
                        form.querySelector('input[name="width"]').value = '640';
                        form.querySelector('input[name="height"]').value = '480';
                      } else if (orientation === 'portrait') {
                        form.querySelector('input[name="width"]').value = '480';
                        form.querySelector('input[name="height"]').value = '640';
                      }
                    }
                  </script>
                {% else %}
                  <form action="/draw" method="post">
                    <input type="hidden" name="parent_post_id" value="{{ post_id }}" />
                    {% if post.community_id %}
                    <input type="hidden" name="community_id" value="{{ post.community_id }}" />
                    {% endif %}
                    <select name="tool">
                      <option value="neo" selected>PaintBBS NEO</option>
                      <option value="tegaki">Tegaki</option>
                      <option value="cucumber">Cucumber</option>
                    </select>
                    <select name="width">
                      <option value="300" selected>300</option>
                      <option value="350">350</option>
                      <option value="400">400</option>
                      <option value="450">450</option>
                      <option value="500">500</option>
                      <option value="550">550</option>
                      <option value="600">600</option>
                      <option value="650">650</option>
                      <option value="700">700</option>
                      <option value="750">750</option>
                      <option value="800">800</option>
                      <option value="850">850</option>
                      <option value="900">900</option>
                      <option value="950">950</option>
                      <option value="1000">1000</option>
                    </select>
                    X
                    <select name="height">
                      <option value="300" selected>300</option>
                      <option value="350">350</option>
                      <option value="400">400</option>
                      <option value="450">450</option>
                      <option value="500">500</option>
                      <option value="550">550</option>
                      <option value="600">600</option>
                      <option value="650">650</option>
                      <option value="700">700</option>
                      <option value="750">750</option>
                      <option value="800">800</option>
                    </select>
                    <input type="submit" value="Start Drawing" />
                  </form>
                {% endif %}
              </fieldset>
            {% endif %}
          </div>
        </div>
      </div>

      {# Full-width sections below #}
      <div class="post-full-width-section">
        <div class="post-reactions-container">{% include "post_reactions.jinja" %}</div>
      </div>

      <div class="post-comments">
        <h2>{{ ftl_get_message("post-comments") }}</h2>
        <div id="comments">
          {% if comments %}
            {{ comments_macro.comments(comments, current_user) }}
          {% else %}
            <p>
              {{ ftl_get_message("post-no-comments") }}
              {% if not current_user %}{{ ftl_get_message("post-no-comments-signin") }}{% endif %}
            </p>
          {% endif %}
          {% if current_user %}
            <form id="comment-form" hx-post="/comments" hx-swap="outerHTML" hx-target="#comments">
              <input type="hidden" name="post_id" value="{{ post_id }}">
              <input type="hidden" id="parent_comment_id" name="parent_comment_id" value="">
              <div id="reply-info" style="display: none; margin-bottom: 10px; padding: 8px; background: var(--secondary-bg-color); border-left: 3px solid var(--main-border-color);">
                <span id="reply-to-text"></span>
                <button type="button"
                        hx-on:click="document.getElementById('parent_comment_id').value = ''; document.getElementById('reply-info').style.display = 'none';"
                        style="margin-left: 10px;">Cancel</button>
              </div>
              <textarea id="comment-content" name="content"></textarea>
              <button type="submit">{{ ftl_get_message("post-comment") }}</button>
            </form>
          {% endif %}
        </div>
      </div>

      {% if child_posts %}
        <div class="post-child-posts">
          <h2>{{ ftl_get_message("post-child-posts") }}</h2>
          {% for child in child_posts %}
            {{ render_post_card(child, 0) }}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
{% endblock content %}
