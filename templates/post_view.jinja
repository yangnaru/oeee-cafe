{% import "comments_macro.jinja" as comments_macro %}
{% extends "base.jinja" %}
{% block title %}
  {{ super() }} |
  {% if post.title %}
    {{ post.title }}
  {% else %}
    {{ ftl_get_message("post-no-title") }}
  {% endif %}
{% endblock title %}
{% block head %}
  <link rel="alternate"
        type="application/activity+json"
        href="https://{{ domain }}/ap/posts/{{ post.id }}" />
  <meta property="og:title" content="{{ post.title }}" />
  <meta property="og:description" content="{{ post.content }}" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="{{ base_url|safe }}/posts/{{ post_id }}" />
  <meta property="og:image"
        content="{{ r2_public_endpoint_url|safe }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
  <meta property="twitter:site" content="@oeee_cafe">
  <meta property="twitter:domain" content="oeee.cafe">
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:url"
        content="{{ base_url|safe }}/posts/{{ post_id }}">
  <meta name="twitter:title" content="{{ post.title }}">
  <meta name="twitter:description" content="{{ post.content }}">
  <meta name="twitter:image"
        content="{{ r2_public_endpoint_url|safe }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}">
{% endblock head %}
{% block content %}
  <div class="center">
    <div class="post-sidebar">
      <div class="post-main">
        <p>{{ ftl_get_message("post-published-at") }}: {{ post.published_at }}</p>
        <p>
          {{ ftl_get_message("post-duration") }}: {{ post.paint_duration }}
          {% if post.replay_filename %}
            <a href="/@{{ post.login_name }}/{{ post_id }}/replay">{{ ftl_get_message("post-replay") }}</a>
          {% endif %}
        </p>
        <p>HIT: {{ post.viewer_count }}</p>
        <p>
          {{ ftl_get_message("community") }}:
          <a href="/communities/@{{ post.community_slug }}">{{ post.community_name }}</a>
          {% if current_user.id == post.author_id -%}
            (<a href="/posts/{{ post_id }}/edit/community">{{ ftl_get_message("edit") }}</a>)
          {%- endif %}
        </p>
        {% if post.image_tool == "neo" and post.allow_relay == "true" %}
          <a href="/@{{ post.login_name }}/{{ post_id }}/relay">
            <img class="post-image-full"
                 width="{{ post.image_width }}"
                 height="{{ post.image_height }}"
                 alt="{{ post.title }}"
                 src="{{ r2_public_endpoint_url|safe }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
          </a>
          <p>
            <i>{{ ftl_get_message("post-relay-enabled-notice") }}</i>
          </p>
        {% else %}
          <img class="post-image-full"
               width="{{ post.image_width }}"
               height="{{ post.image_height }}"
               alt="{{ post.title }}"
               src="{{ r2_public_endpoint_url|safe }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
        {% endif %}
        {% if current_user %}
          <div class="post-reply-actions">
            {% if post.image_tool == "neo" and post.allow_relay == "true" %}
              <button type="button" onclick="window.location.href='/@{{ post.login_name }}/{{ post_id }}/relay'">{{ ftl_get_message("post-relay") }}</button>
            {% endif %}
            <button type="button" onclick="document.getElementById('reply-form-{{ post_id }}').style.display = document.getElementById('reply-form-{{ post_id }}').style.display === 'none' ? 'block' : 'none'">{{ ftl_get_message("post-reply-with-drawing") }}</button>
            <fieldset id="reply-form-{{ post_id }}" style="display: none; margin-top: 10px;">
              <legend>{{ ftl_get_message("post-reply-select-tool") }}</legend>
              <form action="/draw" method="post">
                <input type="hidden" name="parent_post_id" value="{{ post_id }}" />
                <input type="hidden" name="community_id" value="{{ post.community_id }}" />
                <select name="tool">
                  <option value="neo" selected>PaintBBS NEO</option>
                  <option value="tegaki">Tegaki</option>
                  <option value="cucumber">Cucumber</option>
                </select>
                <select name="width">
                  <option value="300" selected>300</option>
                  <option value="350">350</option>
                  <option value="400">400</option>
                  <option value="450">450</option>
                  <option value="500">500</option>
                  <option value="550">550</option>
                  <option value="600">600</option>
                  <option value="650">650</option>
                  <option value="700">700</option>
                  <option value="750">750</option>
                  <option value="800">800</option>
                  <option value="850">850</option>
                  <option value="900">900</option>
                  <option value="950">950</option>
                  <option value="1000">1000</option>
                </select>
                X
                <select name="height">
                  <option value="300" selected>300</option>
                  <option value="350">350</option>
                  <option value="400">400</option>
                  <option value="450">450</option>
                  <option value="500">500</option>
                  <option value="550">550</option>
                  <option value="600">600</option>
                  <option value="650">650</option>
                  <option value="700">700</option>
                  <option value="750">750</option>
                  <option value="800">800</option>
                </select>
                <input type="submit" value="Start Drawing" />
              </form>
            </fieldset>
          </div>
        {% endif %}
        <div class="center">
          <p>
            {{ ftl_get_message("post-author") }}: <a href="/@{{ post.login_name }}">{{ post.display_name }}</a> <span class="muted fediverse-handle">@{{ post.login_name }}@{{ domain }}</span>
          </p>
          {% if collaborative_participants %}
            <div class="collaborative-participants">
              <p>
                <strong>{{ ftl_get_message("post-collaborative-participants") }}:</strong>
              </p>
              <ul>
                {% for participant in collaborative_participants %}
                  <li>
                    <a href="/@{{ participant.login_name }}">@{{ participant.display_name }}</a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          {% block post_edit_block %}
            <div hx-target="this" hx-swap="outerHTML">
              <p>
                {{ ftl_get_message("post-title") }}:
                {% if post.title %}
                  {{ post.title }}
                {% else %}
                  {{ ftl_get_message("post-no-title") }}
                {% endif %}
                {% if parent_post_id %}<a href="/@{{ parent_post_author_login_name }}/{{ parent_post_id }}">â†µ</a>{% endif %}
              </p>
              <p>
                {{ ftl_get_message("post-description") }}:
                <div class="post-content">{{ post.content|markdown|safe }}</div>
              </p>
              {% if hashtags %}
                <div class="post-hashtags">
                  {% for hashtag in hashtags %}
                    <a href="/hashtags/{{ hashtag.name }}" class="hashtag-link">#{{ hashtag.display_name }}</a>
                  {% endfor %}
                </div>
              {% endif %}
              {% if current_user.id == post.author_id %}
                <div class="post-menu">
                  <button hx-get="/posts/{{ post_id }}/edit">{{ ftl_get_message("edit") }}</button>
                  <form hx-delete="/posts/{{ post_id }}"
                        hx-confirm="{{ ftl_get_message('post-delete-confirm') }}"
                        hx-target="body">
                    <button type="submit">{{ ftl_get_message("delete") }}</button>
                  </form>
                </div>
              {% endif %}
            </div>
          {% endblock post_edit_block %}
          <div class="post-reactions-container">{% include "post_reactions.jinja" %}</div>
          <div class="post-share">
            <a href="https://twitter.com/share?ref_src=twsrc%5Etfw"
               class="twitter-share-button"
               data-text="{%- if post.title -%}{{ post.title }}{%- else -%}{{ ftl_get_message("post-no-title") }}{%- endif -%}"
               data-hashtags="oeee_cafe"
               data-related="oeee_cafe"
               data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
          </div>
        </div>
      </div>
      <div class="post-comments">
        <h2>{{ ftl_get_message("post-comments") }}</h2>
        <div id="comments">
          {% if current_user %}
            <form hx-post="/comments" hx-swap="outerHTML" hx-target="#comments">
              <input type="hidden" name="post_id" value="{{ post_id }}">
              <textarea name="content"></textarea>
              <button type="submit">{{ ftl_get_message("post-comment") }}</button>
            </form>
          {% endif %}
          {% if comments %}
            {{ comments_macro.comments(comments) }}
          {% else %}
            <p>
              {{ ftl_get_message("post-no-comments") }}
              {% if not current_user %}{{ ftl_get_message("post-no-comments-signin") }}{% endif %}
            </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
