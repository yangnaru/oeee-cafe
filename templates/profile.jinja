{% from "follow_macro.jinja" import follow_button, unfollow_button %} {% extends "base.jinja" %}
{% block title %}
  {{ super() }} | {{ user.display_name }} (@{{ user.login_name }})
{% endblock title %}
{% block head %}
  <link rel="alternate"
        type="application/activity+json"
        href="https://{{ domain }}/ap/users/{{ user.id }}" />
{% endblock head %}
{% block content %}
  <div class="center">
    <div class="profile-header">
      <h2>
        {{ user.display_name }}
        <span class="muted fediverse-handle">@{{ user.login_name }}@{{ domain }}</span>
        {% if user.id == current_user.id %}<a href="/@{{ user.login_name }}/settings">{{ ftl_get_message("profile-manage") }}</a>{% endif %}
      </h2>
      <div class="banner-controls">
        {% if current_user %}
          {% if is_following %}
            {{ unfollow_button() }} {%
            else %} {{ follow_button() }}
          {% endif %}
          {% if user.id != current_user.id %}
            <button type="button" onclick="showProfileReportModal('{{ user.login_name }}')">{{ ftl_get_message("profile-report") }}</button>
          {% endif %}
        {% endif %}
        {% if banner %}
          {%
          if user.id == current_user.id %}<a href="/banners/draw">
          <img width="{{ banner.width }}"
               height="{{ banner.height }}"
               alt="{{ current_user.display_name }} (@{{ current_user.login_name }}) 동맹 배너"
               class="banner"
               src="{{ r2_public_endpoint_url }}/image/{{ banner.image_filename[:2] }}/{{ banner.image_filename }}" />
        </a>
      {% else %}
        <img width="{{ banner.width }}"
             height="{{ banner.height }}"
             alt="{{ user.display_name }} (@{{ user.login_name }}) 동맹 배너"
             class="banner"
             src="{{ r2_public_endpoint_url }}/image/{{ banner.image_filename[:2] }}/{{ banner.image_filename }}" />
      {% endif %}
    {% else %}
      {% if user.id == current_user.id %}<a href="/banners/draw" class="button">{{ ftl_get_message("profile-draw-banner") }}</a>{% endif %}
    {% endif %}
  </div>
</div>
<div class="flex-inline">
  <h3>{{ ftl_get_message("profile-link") }}</h3>
</div>
<ul class="links">
  <li>
    <a href="/@{{ user.login_name }}/guestbook">{{ ftl_get_message("profile-guestbook") }}</a>
  </li>
  {% for link, target in links %}
    <li>
      <a href="{{ link.url }}" target="{{ target }}">{{ link.description }}</a>
    </li>
  {% endfor %}
</ul>
{% if followings|length > 0 %}
  {% if
    followings|selectattr("banner_image_filename")|length > 0 %}
    <h3>{{ ftl_get_message("profile-banner") }}</h3>
    <div class="banners-grid">
      {% for following in followings|selectattr("banner_image_filename") %}
        <div class="banners-grid-item">
          <a href="/@{{ following.login_name }}"
             alt="{{ following.display_name }} (@{{ following.login_name }})">
            <img width="{{ following.banner_image_width }}"
                 height="{{ following.banner_image_height }}"
                 alt="{{ following.display_name }} (@{{ following.login_name }}) 동맹 배너"
                 class="banner"
                 src="{{ r2_public_endpoint_url }}/image/{{ following.banner_image_filename[:2] }}/{{ following.banner_image_filename }}" />
          </a>
        </div>
      {% endfor %}
    </div>
  {% endif %}
  {% if followings|rejectattr("banner_image_filename")|length > 0 %}
    <h3>{{ ftl_get_message("profile-following") }}</h3>
    <ul class="followings-list">
      {% for following in followings|rejectattr("banner_image_filename") %}
        <li>
          <a href="/@{{ following.login_name }}">{{ following.display_name }}</a>
          <br />
          <span class="muted">@{{ following.login_name }}</span>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
{% endif %}
<h3>{{ ftl_get_message("profile-public-community-posts") }}</h3>
{% if public_community_posts %}
  <div class="posts-grid">
    {% for post in public_community_posts %}
      <div class="posts-grid-item">
        <a href="/@{{ user.login_name }}/{{ post.id }}">
          <img width="{{ post.image_width }}"
               height="{{ post.image_height }}"
               alt="{{ post.title }}"
               src="{{ r2_public_endpoint_url }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
        </a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>{{ ftl_get_message("profile-public-community-posts-nil") }}</p>
{% endif %}
{% if user.id == current_user.id %}
  <h3>{{ ftl_get_message("profile-private-community-posts") }}</h3>
  {% if private_community_posts %}
    <div class="posts-grid">
      {% for post in private_community_posts %}
        <div class="posts-grid-item">
          <a href="/@{{ user.login_name }}/{{ post.id }}">
            <img width="{{ post.image_width }}"
                 height="{{ post.image_height }}"
                 alt="{{ post.title }}"
                 src="{{ r2_public_endpoint_url }}/image/{{ post.image_filename[:2] }}/{{ post.image_filename }}" />
          </a>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>{{ ftl_get_message("profile-private-community-posts-nil") }}</p>
  {% endif %}
{% endif %}

{# Profile Report Modal #}
{% if current_user and user.id != current_user.id %}
  <div id="profile-report-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--main-bg-color); padding: 20px; border-radius: 8px; max-width: 500px; width: 90%;">
      <h2>{{ ftl_get_message("profile-report-title") }}</h2>
      <form id="profile-report-form" onsubmit="submitProfileReport(event)">
        <label for="profile-report-description">{{ ftl_get_message("profile-report-description-label") }}</label>
        <textarea id="profile-report-description"
                  name="description"
                  required
                  rows="5"
                  style="width: 100%; margin-top: 8px; padding: 8px;"
                  placeholder="{{ ftl_get_message('profile-report-description-placeholder') }}"></textarea>
        <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
          <button type="button" onclick="hideProfileReportModal()">{{ ftl_get_message("cancel") }}</button>
          <button type="submit">{{ ftl_get_message("profile-report-submit") }}</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentReportLoginName = '';

    function showProfileReportModal(loginName) {
      currentReportLoginName = loginName;
      const modal = document.getElementById('profile-report-modal');
      modal.style.display = 'flex';
      document.getElementById('profile-report-description').value = '';
      document.getElementById('profile-report-description').focus();
    }

    function hideProfileReportModal() {
      document.getElementById('profile-report-modal').style.display = 'none';
      currentReportLoginName = '';
    }

    async function submitProfileReport(event) {
      event.preventDefault();
      const description = document.getElementById('profile-report-description').value.trim();

      if (description.length === 0) {
        alert('{{ ftl_get_message("profile-report-error") }}');
        return;
      }

      try {
        const response = await fetch(`/api/v1/profiles/${currentReportLoginName}/report`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ description }),
        });

        if (response.ok) {
          alert('{{ ftl_get_message("profile-report-success") }}');
          hideProfileReportModal();
        } else {
          const error = await response.json();
          alert(error.message || '{{ ftl_get_message("profile-report-error") }}');
        }
      } catch (error) {
        alert('{{ ftl_get_message("profile-report-error") }}');
      }
    }

    // Close modal when clicking outside
    document.getElementById('profile-report-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideProfileReportModal();
      }
    });
  </script>
{% endif %}
</div>
{% endblock content %}
