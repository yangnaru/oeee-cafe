{% macro comment_item(comment, current_user) %}
  {# Only show comment if it's not deleted, or if it's deleted but has children #}
  {% if not comment.deleted_at or (comment.children and comment.children|length > 0) %}
  <div class="comment-wrapper">
    <div class="comment" id="comment-{{ comment.id }}">
      <div class="comment-body">
        <div class="comment-header">
          {% if comment.is_local %}
            <a href="{{ comment.actor_url }}" class="comment-author">{{ comment.actor_name }}</a>
          {% else %}
            <a href="{{ comment.actor_url }}" class="comment-author" target="_blank" rel="noopener noreferrer">{{ comment.actor_name }}</a>
          {% endif %}
          <span class="muted comment-handle">{{ comment.actor_handle }}</span>
          <span class="muted comment-timestamp">{{ comment.created_at|datetimeformat(format="short", tz="Asia/Seoul") }}</span>
        </div>
        <div class="comment-content">
          {% if comment.deleted_at %}
            <span class="comment-deleted">[deleted]</span>
          {% elif comment.content_html %}
            {{ comment.content_html|safe }}
          {% elif comment.content %}
            {{ comment.content|markdown|safe }}
          {% else %}
            <span class="comment-deleted">[deleted]</span>
          {% endif %}
        </div>
        {% if not comment.deleted_at %}
        <div class="comment-actions">
          <button class="comment-reply-btn"
                  hx-on:click="document.getElementById('parent_comment_id').value = '{{ comment.id }}';
                               document.getElementById('reply-to-text').textContent = 'Replying to {{ comment.actor_name }}';
                               document.getElementById('reply-info').style.display = 'block';
                               document.getElementById('comment-content').focus();
                               document.getElementById('comment-form').scrollIntoView({ behavior: 'smooth', block: 'center' });">
            Reply
          </button>
          {% if current_user and comment.is_local and comment.actor_login_name == current_user.login_name %}
          <button class="comment-delete-btn"
                  hx-delete="/api/v1/comments/{{ comment.id }}"
                  hx-confirm="Are you sure you want to delete this comment?"
                  hx-target="closest .comment-wrapper"
                  hx-swap="outerHTML">
            Delete
          </button>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
    {% if comment.children and comment.children|length > 0 %}
      <div class="comment-replies">
        {% for child in comment.children %}
          {{ comment_item(child, current_user) }}
        {% endfor %}
      </div>
    {% endif %}
  </div>
  {% endif %}
{% endmacro %}

{% macro comments(comments, current_user) %}
  {% for comment in comments %}
    {{ comment_item(comment, current_user) }}
  {% endfor %}
{% endmacro %}
