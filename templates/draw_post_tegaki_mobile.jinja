<!DOCTYPE html>
<html lang="{{ ftl_lang }}">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>
      {% if parent_post %}
        Re: {{ parent_post.title }} @ {{ community_name }}
      {% else %}
        {{ ftl_get_message("community-drawing-new") }} @ {{ community_name }}
      {% endif %}
    </title>
    <link rel="stylesheet"
          href="{{ '/static/tegaki/css/tegaki.css' | cachebuster | safe }}" />
    <script src="{{ '/static/tegaki/js/strings/en.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/tool.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/brush.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/pencil.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/pen.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/airbrush.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/blur.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/bucket.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/eraser.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/pipette.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/tools/tone.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/$T.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/cursor.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/history.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/layers.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/keybinds.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/palettes.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/ui.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/pressure.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/replayevents.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/replayrecorder.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/binary.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/js/main.js' | cachebuster | safe }}"></script>
    <script src="{{ '/static/tegaki/lib/UZIP/UZIP.js' | cachebuster | safe }}"></script>
    <style>
    body {
      margin: 0;
      padding: 0;
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      overflow: hidden;
    }
    #tegaki {
      height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
    }
    #tegaki-menu-bar > span:nth-child(1) {
      display: none;
    }
    #tegaki-menu-bar > span:nth-child(2) {
      display: none;
    }
    </style>
  </head>
  <body>
    <script type="text/javascript">
    // Unified native bridge for iOS and Android
    window.NativeBridge = {
      postMessage: function(message) {
        try {
          // iOS WKWebView
          if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.oeee) {
            window.webkit.messageHandlers.oeee.postMessage(message);
            return;
          }

          // Android WebView
          if (window.OeeeCafe && window.OeeeCafe.postMessage) {
            window.OeeeCafe.postMessage(JSON.stringify(message));
            return;
          }

          // Fallback for web debugging
          console.log('NativeBridge message:', message);
        } catch (error) {
          console.error('NativeBridge error:', error);
        }
      }
    };

    function onTegakiDone() {
      Tegaki.replayRecorder.stop();
      const image = Tegaki.flatten();
      const animation = Tegaki.replayRecorder.toBlob();

      const form = new FormData();
      form.append("image", image.toDataURL("image/png"));
      form.append("animation", animation, "blob");
      form.append("community_id", "{{ community_id }}");
      form.append("security_timer", Tegaki.startTimeStamp);
      form.append("security_count", securityCount);
      form.append("width", image.width);
      form.append("height", image.height);
      form.append("tool", "tegaki");

      {% if parent_post %}
      form.append("parent_post_id", "{{ parent_post.id }}");
      {% elif parent_post_id %}
      form.append("parent_post_id", "{{ parent_post_id }}");
      {% endif %}

      // Post form to server
      fetch("/draw/finish", {
        method: "POST",
        body: form,
      })
        .then((response) => response.json())
        .then(async (data) => {
          if (data?.error) {
            alert(data.error);
          } else {
            // Notify native app of completion
            window.NativeBridge.postMessage({
              type: 'drawing_complete',
              postId: data.post_id,
              communityId: data.community_id,
              imageUrl: data.image_url
            });
          }
        })
        .catch((error) => {
          alert("{{ ftl_get_message("community-drawing-post-error") }}");
          console.error('Upload error:', error);
        });

      return false;
    }

    Tegaki.open({
      saveReplay: true,
      onDone: onTegakiDone,
      width: {{ width }},
      height: {{ height }},
    });

    let securityCount = 0;
    document.getElementById("tegaki").addEventListener("pointerdown", () => {
      securityCount++;
    });
    </script>
  </body>
</html>
